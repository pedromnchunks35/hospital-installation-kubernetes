pipeline {
    agent {
        node {
            label 'default'
        }
    }
    environment {
        KUBECONFIG = "/etc/kubernetes/admin_hospital.conf"
        PATH = "$PATH:/run/media/pedromn35/disk2-home/manually-installed-bins/fabric-samples/bin/:/run/media/pedromn35/disk2-home/manually-installed-bins/go/bin/"
        YAML_FILES_LOCATION = "/run/media/pedromn35/disk2-home/projects/hospital-installation-kubernetes/Benchmarking/kubernetes-network/kuber-components/"
        TS_SCRIPT_NETWORK_AUTOMATION_LOCATION = "/run/media/pedromn35/disk2-home/projects/hospital-installation-kubernetes/Benchmarking/kubernetes-network/kuber-components/network-automation-config"
        BENCHMARKING_FILES_LOCATION = "/run/media/pedromn35/disk2-home/projects/hospital2/monitoring/caliper-k8"
        BENCH_PROFILE = "finaltest"
    }
    stages {
        stage('Erase Network') {
            steps {
                sh '''
                expect << EOF
                    spawn ssh -l root CHP-SRVAIDA69.chuporto.min-saude.pt "sh ./reset-k8.sh"
                    expect "password:"
                    send "h0sp1talSA\\r"
                    expect eof

                    spawn ssh -l root CHP-SRVAIDA70.chuporto.min-saude.pt "sh ./reset-k8.sh"
                    expect "password:"
                    send "h0sp1talSA\\r"
                    expect eof

                    spawn ssh -l root SA-SRVAIDA77 "sh ./reset-k8.sh"
                    expect "password:"
                    send "h0sp1talSA\\r"
                    expect eof
                '''
            }
        }
        stage('Restart K8 Components') {
            steps {
                sh '''
                cd $YAML_FILES_LOCATION
                ./clear.sh
                '''
            }
        }
        stage('Config components') {
            steps {
                sh '''
                cd $TS_SCRIPT_NETWORK_AUTOMATION_LOCATION
                echo "Sleeping a bit to let the components get up"
                sleep 100
                node main.js
                '''
            }
        }
        stage('Start Benchmarking') {
            steps {
                sh '''
                cd $BENCHMARKING_FILES_LOCATION
                ./start.sh $BENCH_PROFILE
                '''
            }
        }
    }
}